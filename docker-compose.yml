version: '3.8'

services:

  database:
    image: mysql
    container_name: exip_db
    restart: always
    command: --default-authentication-plugin=mysql_native_password
    ports:
      - "${DATABASE_PORT}:${DATABASE_PORT}"
    volumes:
      - ./database/exip.sql:/docker-entrypoint-nitdb.d/database.sql:rw
    environment:
      MYSQL_DATABASE:
      MYSQL_ROOT_PASSWORD:
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      retries: 3
      interval: 60s
      timeout: 10s
      start_period: 30s

  api:
    build:
      context: ./src/api
      args:
        PORT: ${API_PORT}
        SESSION_SECRET: ${SESSION_SECRET}
        GOV_NOTIFY_API_KEY: ${GOV_NOTIFY_API_KEY}
    image: api
    container_name: exip_api
    restart: always
    command: npm run start
    depends_on:
      - database
    ports:
      - "${API_PORT}:${API_PORT}"
    volumes:
      - ./.api/src:/app/src:ro
      - ./.api/src/.keystone:/app/src/.keystone:ro
    environment:
      NODE_ENV:
      PORT: ${API_PORT}
      DATABASE_URL:
      SESSION_SECRET:
      GOV_NOTIFY_API_KEY:
      COMPANIES_HOUSE_API_URL:
      COMPANIES_HOUSE_API_KEY:
      JWT_SIGNING_KEY:
      JWT_VALIDATING_KEY:
      GOV_NOTIFY_EMAIL_RECIPIENT_1:
      GOV_NOTIFY_EMAIL_RECIPIENT_2:
      UNDERWRITING_TEAM_EMAIL:
      MOCK_ACCOUNT_PASSWORD:

  ui:
    build:
      context: ./src/ui
      args:
        PORT: ${UI_PORT}
    image: ui
    container_name: exip_ui
    restart: always
    depends_on:
      - database
      - api
    ports:
      - "${UI_PORT}:${UI_PORT}"
    volumes:
      - ./src/ui/server:/app/server:ro
      - ./src/ui/public:/app/public:ro
      - ./src/ui/templates:/app/templates:ro
    environment:
      PORT: ${UI_PORT}
      NODE_ENV:
      API_URL:
      BASIC_AUTH_KEY:
      BASIC_AUTH_SECRET:
      MULESOFT_API_CIS_URL:
      MULESOFT_API_CIS_KEY:
      MULESOFT_API_CIS_SECRET:
      MULESOFT_API_MDM_EA_URL:
      MULESOFT_API_MDM_EA_KEY:
      MULESOFT_API_MDM_EA_SECRET:
      GOOGLE_ANALYTICS_ID:
      GOV_NOTIFY_EMAIL_RECIPIENT_1:
      GOV_NOTIFY_EMAIL_RECIPIENT_2:
      MOCK_ACCOUNT_PASSWORD:
    entrypoint: npx nodemon src/index.ts -L
