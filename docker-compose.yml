version: '3.3'

services:

  database:
    image: mysql
    restart: always
    ports:
      - "3306:3306"
    volumes:
      - ./.database/data:/var/lib/mysql
      - ./.database/log:/var/log/mysql
      - ./.database/mysql:/etc/mysql/conf.d
    environment:
      MYSQL_DATABASE: exip
      MYSQL_ROOT_PASSWORD: password

  api:
    build: ./src/api
    image: exip/src/api
    restart: always
    command: npm run start
    depends_on:
      - database
    ports:
      - "5001:5001"
    volumes:
      - ./.api/src:/app/src:ro
      - ./.api/src/.keystone:/app/src/.keystone:ro
    environment:
      PORT: 5001
      DATABASE_URL: mysql://root:password@database:3306/exip

  ui:
    build: ./src/ui
    image: exip/src/ui
    restart: always
    depends_on:
      - database
      - api
    ports:
      - "5000:5000"
    volumes:
      - ./src/ui/server:/app/server:ro
      - ./src/ui/public:/app/public:ro
      - ./src/ui/templates:/app/templates:ro
    environment:
      PORT: 5000
      API_URL:
      BASIC_AUTH_KEY:
      BASIC_AUTH_SECRET:
      MULESOFT_API_CIS_URL:
      MULESOFT_API_CIS_KEY:
      MULESOFT_API_CIS_SECRET:
      MULESOFT_API_MDM_EA_URL:
      MULESOFT_API_MDM_EA_KEY:
      MULESOFT_API_MDM_EA_SECRET:
      GOOGLE_ANALYTICS_ID:
    entrypoint: npx nodemon src/index.ts -L