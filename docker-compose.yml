version: '3.3'

services:

  database:
    image: mysql
    restart: always
    command: --default-authentication-plugin=mysql_native_password
    ports:
      - "3306:3306"
    volumes:
      - ./database/exip.sql:/docker-entrypoint-initdb.d/database.sql
    environment:
      MYSQL_DATABASE:
      MYSQL_ROOT_PASSWORD:

  api:
    build:
      context: ./src/api
      args:
        SESSION_SECRET: ${SESSION_SECRET}
        GOV_NOTIFY_API_KEY: ${GOV_NOTIFY_API_KEY}
    image: exip/src/api
    restart: always
    command: npm run start
    depends_on:
      - database
    ports:
      - "5001:5001"
    volumes:
      - ./.api/src:/app/src:ro
      - ./.api/src/.keystone:/app/src/.keystone:ro
    environment:
      PORT: 5001
      DATABASE_URL:
      SESSION_SECRET:
      GOV_NOTIFY_API_KEY:
      COMPANIES_HOUSE_API_URL:
      COMPANIES_HOUSE_API_KEY:
      JWT_SIGNING_KEY:
      JWT_VALIDATING_KEY:

  ui:
    build: ./src/ui
    image: exip/src/ui
    restart: always
    depends_on:
      - database
      - api
    ports:
      - "5000:5000"
    volumes:
      - ./src/ui/server:/app/server:ro
      - ./src/ui/public:/app/public:ro
      - ./src/ui/templates:/app/templates:ro
    environment:
      PORT: 5000
      API_URL:
      BASIC_AUTH_KEY:
      BASIC_AUTH_SECRET:
      MULESOFT_API_CIS_URL:
      MULESOFT_API_CIS_KEY:
      MULESOFT_API_CIS_SECRET:
      MULESOFT_API_MDM_EA_URL:
      MULESOFT_API_MDM_EA_KEY:
      MULESOFT_API_MDM_EA_SECRET:
      GOOGLE_ANALYTICS_ID:
      GOV_NOTIFY_EMAIL_RECIPIENT:
      GOV_NOTIFY_EMAIL_RECIPIENT_2:
      MOCK_ACCOUNT_PASSWORD:
    entrypoint: npx nodemon src/index.ts -L
