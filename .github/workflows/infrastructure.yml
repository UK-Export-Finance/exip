# This GHA is responsible for `EXIP` base infrastructure
# creation using AZ CLI. Following resources are created:
#
# 1. ACR
# 2. WebApp
name: Infrastructure 🔨
run-name: EXIP Base infrastructure build on ${{ github.repository }}

on:
  push:
    branches: [ infrastructure ]
    paths: 
    - '.github/workflows/infrastructure.yml'

env:
  product: exip

jobs:

# Development environment
  development:
    name: Development 🚀
    environment: dev
    runs-on: [ self-hosted, linux, deployment, infrastructure ]
    env:
      plan: dev
      acr: ${{ secrets.ACR_SERVER }}
      acr_username: ${{ secrets.ACR_USERNAME }}
      acr_password: ${{ secrets.ACR_PASSWORD }}
    steps:

    - name: Azure Login 🔐
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: Azure Defaults ✨
      uses: azure/cli@v1.0.0
      with:
        inlineScript: |
          az configure --defaults location=${{ secrets.AZURE_REGION }}
          az configure --defaults group=${{ secrets.RESOURCE_GROUP }}

    - name: ACR 📦️
      uses: azure/cli@v1.0.0
      with:
        inlineScript: |
          az acr create --name ${{ secrets.ACR }} --sku Standard --admin-enabled true

    - name: WebApp UI 🌐
      uses: azure/cli@v1.0.0
      env:
        name: ui
      with:
        inlineScript: |
          az webapp create --name ${{ env.product }}-${{ env.plan }}-${{ env.name }} \
          --plan ${{ env.plan }} \
          --deployment-container-image-name ${{ env.acr }}/${{ env.name }}:${{ env.plan }}

# Production environment
  production:
    name: Production 🚀
    environment: prod
    runs-on: [ self-hosted, linux, deployment, infrastructure ]
    steps:

    - name: Azure Login 🔐
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: Azure Defaults ✨
      uses: azure/cli@v1.0.0
      with:
        inlineScript: |
          az configure --defaults location=${{ secrets.AZURE_REGION }}
          az configure --defaults group=${{ secrets.RESOURCE_GROUP }}

    - name: ACR 📦️
      uses: azure/cli@v1.0.0
      with:
        inlineScript: |
          az acr create --name ${{ secrets.ACR }} --sku Standard --admin-enabled true
