name: PR tests

on:
  pull_request:

env:
  environment: qa

jobs:
  set-environment:
    name: Set Environment
    runs-on: ubuntu-latest
    outputs:
      environment: ${{ env.environment }}
    steps:
      - name: Initialise Environment
        run: |
          echo Setting environment to ${{ env.environment }}

  linting:
    name: Run linting
    environment:
      name: ${{ needs.set-environment.outputs.environment }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v2
        with:
          node-version: "16"
      - name: Linting
        working-directory: ./src/ui
        run: |
          npm install --legacy-peer-deps
          cd ../../
          npm install --legacy-peer-deps
          npm run lint

  unit-tests:
    name: Run unit tests
    environment:
      name: ${{ needs.set-environment.outputs.environment }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v2
        with:
          node-version: "16"
      - name: Unit tests
        working-directory: ./src/ui
        run: |
          npm install --legacy-peer-deps
          npm run test

  e2e-tests:
    name: Run e2e tests
    needs: set-environment
    environment:
      name: ${{ needs.set-environment.outputs.environment }}
    runs-on: ubuntu-latest

    strategy:
      # Do not cancel in-progress jobs upon failure
      fail-fast: false
      # Single dimension matrix
      matrix:
        spec:
          ["/*.spec.js", "cookies-consent/**/*.spec.js", "quote/**/*.spec.js"]

    concurrency:
      group: e2e-tests-${{ github.workflow }}-${{ github.workflow_ref }}-${{ matrix.spec }}
      cancel-in-progress: true

    env:
      NODE_ENV: ${{ secrets.NODE_ENV }}
      BASIC_AUTH_KEY: ${{ secrets.BASIC_AUTH_KEY }}
      BASIC_AUTH_SECRET: ${{ secrets.BASIC_AUTH_SECRET }}
      USER_1_KEY: ${{ secrets.USER_1_KEY }}
      USER_1_SECRET: ${{ secrets.USER_1_SECRET }}
      USER_2_KEY: ${{ secrets.USER_2_KEY }}
      USER_2_SECRET: ${{ secrets.USER_2_SECRET }}
      USER_3_KEY: ${{ secrets.USER_3_KEY }}
      USER_3_SECRET: ${{ secrets.USER_3_SECRET }}
      USER_4_KEY: ${{ secrets.USER_4_KEY }}
      USER_4_SECRET: ${{ secrets.USER_4_SECRET }}
      USER_5_KEY: ${{ secrets.USER_4_KEY }}
      USER_5_SECRET: ${{ secrets.USER_5_SECRET }}
      GOOGLE_ANALYTICS_ID: ${{ secrets.GOOGLE_ANALYTICS_ID }}
      APIM_MDM_URL: ${{ secrets.APIM_MDM_URL }}
      APIM_MDM_KEY: ${{ secrets.APIM_MDM_KEY }}
      APIM_MDM_VALUE: ${{ secrets.APIM_MDM_VALUE }}

    steps:
      - uses: actions/checkout@v4

      - name: Timezone
        uses: szenius/set-timezone@v1.2
        with:
          timezoneLinux: ${{ needs.setup.outputs.timezone }}

      - name: Dependencies
        working-directory: ./
        run: npm ci --legacy-peer-deps

      - name: Docker
        run: docker-compose up --build -d

      - name: Wait
        run: sleep 30s

      - name: Execute
        working-directory: ./e2e-tests/quote
        run: npx cypress run --config video=false,screenshotOnRunFailure=false --browser chrome --project ./ --record false --spec "cypress/e2e/journeys/${{ matrix.spec }}" --env TZ=${{ env.timezone }},API_KEY=${{ secrets.API_KEY }},GOV_NOTIFY_EMAIL_RECIPIENT_1=${{ secrets.GOV_NOTIFY_EMAIL_RECIPIENT_1 }},GOV_NOTIFY_EMAIL_RECIPIENT_2=${{ secrets.GOV_NOTIFY_EMAIL_RECIPIENT_2 }},MOCK_ACCOUNT_PASSWORD=${{ secrets.MOCK_ACCOUNT_PASSWORD }}
